{% extends 'home.html' %}

{% load static %}

{% block title %} {{ page_title }} {% endblock %}

{% block content %}

<meta charset="UTF-8">
<section class="content-view w-full py-0 bg-gray-50">
    <!-- Opciones HC Otros -->
    <div class="content-options flex flex-wrap space-x-4 space-y-0 p-0 m-0 py-0 px-0">
        <div class="relative ml-4 top-3 left-0"> 
            <a href="{% url 'proveedores' %}">
                <button type="button" class="options-med button-50">Consultas</button>
            </a>
        </div>
        <div class="relative ml-4 top-3 left-0">
            <a href="{% url 'proveedores' %}">
                <button type="button" class="options-med button-50">Validaci√≥n</button>
            </a>
        </div>
        <div class="relative ml-4 top-3 left-0">
            <a href="{% url 'proveedores' %}">
                <button type="button" class="options-med button-50">Cargue</button>
            </a>
        </div>
    </div>
    <!-- Contenedor Filtros -->
    <section id="filters" class="content-filter-med w-full py-20 bg-gray-100">
        <div class="filtered container mx-auto px-4 shadow-lg py-4">
            <form method="GET" action="{% url 'proveedores' %}">
        <!-- Aqu√≠ van los filtros -->
            <div class="flex flex-wrap justify-between space-x-4">
                <div class="relative z-0 mb-6 flex-1 min-w-[200px] border border-gray-300 rounded-md bg-white">
                    <input type="text" name="nombre" id="nombre" class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-gray-100 border-0 border-b-2 border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " />
                    <label for="nombre" class="absolute font-medium text-sm text-gray-500 duration-300 transform -translate-y-6 scale-75 top-3 left-0 origin-[0_0] bg-gray-100 px-1 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-100 peer-focus:-translate-y-5 peer-focus:scale-75">Nombre Proveedor</label>
                </div>
                <div class="relative z-0 mb-6 flex-1 min-w-[200px] border border-gray-300 rounded-md bg-white">
                    <input type="number" name="nit" id="nit" class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-gray-100 border-0 border-b-2 border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " />
                    <label for="nit" class="absolute font-medium text-sm text-gray-500 duration-300 transform -translate-y-6 scale-75 top-3 left-0 origin-[0_0] bg-gray-100 px-1 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-100 peer-focus:-translate-y-5 peer-focus:scale-75">NIT Proveedor</label>
                </div>
            </div>
            <div class="relative inline-block w-64">
                <label for="tipo_proveedor" class="block text-sm font-medium text-gray-700">Tipo de Proveedor</label>
                <select id="tipo_proveedor" name="tipo_proveedor" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for tipo in tipos.all %}
                            <option value="{{ tipo }}">{{ tipo }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="supervisor" class="block text-sm font-medium text-gray-700">Supervisor</label>
                <select id="supervisor" name="supervisor" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for supervisor in supervisores.all %}
                            <option value="{{ supervisor }}">{{ supervisor }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="categoria" class="block text-sm font-medium text-gray-700">Categor√≠a</label>
                <select name="categoria" id="categoria" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for categoria in categorias.all %}
                            <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="complejidad" class="block text-sm font-medium text-gray-700">Complejidad</label>
                <select name="complejidad" id="complejidad" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for complejidad in complejidades.all %}
                            <option value="{{ complejidad }}">{{ complejidad }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="categoria_cuentas_medicas" class="block text-sm font-medium text-gray-700">Categorias Cuentas M√©dicas</label>
                <select name="categoria_cuentas_medicas" id="categoria_cuentas_medicas" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for categoria in categorias_cuentas_medicas.all %}
                            <option value="{{ categoria }}">{{ categoria }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="sucursal" class="block text-sm font-medium text-gray-700">Sucursal</label>
                <select name="sucursal" id="sucursal" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for sucursal in sucursales.all %}
                            <option value="{{ sucursal }}">{{ sucursal }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="departamento" class="block text-sm font-medium text-gray-700">Departamento</label>
                <select name="departamento" id="departamento" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for dpto in departamentos.all %}
                            <option value="{{ dpto }}">{{ dpto }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="municipio" class="block text-sm font-medium text-gray-700">Municipio</label>
                <select name="municipio" id="municipio" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for municipio in municipios.all %}
                            <option value="{{ municipio }}">{{ municipio }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="year_contrato" class="block text-sm font-medium text-gray-700">A√±o</label>
                <select name="year_contrato" id="year_contrato" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for year in years.all %}
                            <option value="{{ year }}">{{ year }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="numero_contrato" class="block text-sm font-medium text-gray-700">N√∫mero de Contrato</label>
                <select name="numero_contrato" id="numero_contrato" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for numero_contrato in numero_contrato.all %}
                            <option value="{{ numero_contrato }}">{{ numero_contrato }}</option>
                        {% endfor %}
                </select>
            </div>
            <div class="relative inline-block w-64">
                <label for="novedad" class="block text-sm font-medium text-gray-700">Novedad en Maestra</label>
                <select name="novedad" id="novedad" class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-base text-gray-700 focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
                    <option value="">Selecciona...</option>
                        {% for novedad in novedades.all %}
                            <option value="{{ novedad }}">{{ novedad }}</option>
                        {% endfor %}
                </select>
            </div>
            
            <!-- Btn buscar !-->
            <button type="submit" class="button-48" role="button"><span class="text">Buscar</span></button>
        </form>
        </div>
    </section>
    <!-- Contenedor Informaci√≥n -->
    <section id="info-buttons" class="content-info w-full lg:w-3/10 py-4 bg-[#e5e8e8] shadow-lg">
        <div class="content-bar container mx-auto px-4 flex justify-between items-center">        
            <div class="flex-1">
                <!-- Aqu√≠ van los labels de span y botones -->
                <p>Registros encontrados <span id="result-query" class="font-semibold">{{ info_page.paginator.count }}</span></p>
                <p>Filtros Aplicados : 
                    <span class="font-semibold">
                        {% if filtros_aplicados %}
                        {{ filtros_aplicados|join:", " }}
                        {% else %}
                        Ning√∫n filtro aplicado
                        {% endif %}
                    </span>
                </p>
                {% if request.GET.nombre|default_if_none:'' == 'enviar correo' %}
                <p>Notificaci√≥n <span class="font-semibold text-[#3030b1]"> üÜó Correo Enviado</span></p>
                <p>√öltima Actualizaci√≥n <span class="font-semibold">15 de diciembre del 2025</span></p>

                {% elif not filtros_aplicados and info_page.paginator.count == 0 %}
                <p><span class="font-semibold text-[#3030b1]">Actualizando Tabla Proveedores</span></p>
                <p><span class="font-semibold text-[#339c33]">Espere un momento por favor ...</span></p>

                {% elif info_page.paginator.count == 0 %}
                <p>√öltima Actualizaci√≥n <span class="font-semibold">02 de enero del 2026</span></p>
                <p><span class="font-semibold text-[#b13030]">‚ö† No se encontraron resultados con los filtros aplicados</span></p>

                {% else %}
                <p>√öltima Actualizaci√≥n <span class="font-semibold">02 de enero del 2026</span></p>
                {% endif %}
            </div>
            <div class="ml-4">
                <button id="toggle-filters" class="button-49" role="button">Ver Filtros</button>
            </div>
            <div class="ml-4">
                <button class="button-actas" role="button">Ver Resumen</button>
            </div>
        </div>
    </section>
    <!-- Vencimientos -->
    <section id="section-vencimientos" class="contenedor-vencimientos content-navidad relative overflow-auto w-full h-[80vh]">
        {% include 'partials/vencimientos.html' %}
    </section>
    <!-- Contenedor Actas Cargadas -->
    <section id="section-actas" class="content-div-actas w-full bg-transparent h-max-auto">
        <div class="content-actas container mx-auto px-4 py-4 h-full bg-transparent">
            <h3 class="title text-3xl font-bold text-center my-6">Proveedores de Servicios de Salud</h3>
            <div class="relative container grid columns-3 justify-between rounded-sm shadow-lg bg-transparent text-[14px] mx-auto px-4 items-center overflow-x-auto h-[67vh]">
                {% for pss in pss %}
                <div class="acta-item p-4 border border-gray-300 shadow-lg mb-4">
                    <p><strong>NIT Proveedor:</strong> {{ pss.nit }}</p>
                    <p><strong>Proveedor:</strong> {{ pss.nombre }}</p>
                    <p><strong>Tipo de Proveedor:</strong> {{ pss.tipo_proveedor }}</p>
                    <p><strong>N√∫mero & A√±o Contrato:</strong> {{ pss.numero_contrato }} - {{ pss.year_contrato }}</p>
                </div>
                {% endfor %}
            </div>
            <p class="subtitle text-[18px] w-full font-bold text-right my-6">Total (PSS) {{ pss|length }}</p>
            <h3 class="title text-3xl font-bold text-center my-6">Proveedores de Tecnolog√≠as en Salud</h3>
            <div class="relative container grid columns-3 justify-between rounded-sm shadow-lg bg-transparent text-[14px] mx-auto px-4 items-center overflow-x-auto h-[67vh]">
                {% for pts in pts %}
                <div class="acta-item p-4 border border-gray-300 shadow-lg mb-4">
                    <p><strong>NIT Proveedor:</strong> {{ pts.nit }}</p>
                    <p><strong>Proveedor:</strong> {{ pts.nombre }}</p>
                    <p><strong>Tipo de Proveedor:</strong> {{ pts.tipo_proveedor }}</p>
                    <p><strong>N√∫mero & A√±o Contrato:</strong> {{ pts.numero_contrato }} - {{ pts.year_contrato }}</p>
                </div>
                {% endfor %}
            </div>
            <p class="subtitle text-[18px] w-full font-bold text-right my-6">Total (PTS) {{ pts|length }}</p>            
            <h3 class="title text-3xl font-bold text-center my-6">Otros Proveedores</h3>
            <div class="relative container grid columns-3 justify-between rounded-sm shadow-lg bg-transparent text-[14px] mx-auto px-4 items-center overflow-x-auto h-[67vh]">
                {% for otro in otros %}
                <div class="acta-item p-4 border border-gray-300 shadow-lg mb-4">
                    <p><strong>NIT Proveedor:</strong> {{ otro.nit }}</p>
                    <p><strong>Proveedor:</strong> {{ otro.nombre }}</p>
                    <p><strong>Tipo de Proveedor:</strong> {{ otro.tipo_proveedor }}</p>
                    <p><strong>N√∫mero & A√±o Contrato:</strong> {{ otro.numero_contrato }} - {{ otro.year_contrato }}</p>
                </div>
                {% endfor %}
            </div>
            <p class="subtitle text-[18px] w-full font-bold text-right my-6">Total (Otros) {{ otros|length }}</p>
        </div>
    </section>
    <!-- Contenedor Tabla -->
    <section id="table-pagination" class="content-navidad w-full lg:w-7/10 py-2">
        <div class="content-pagination-cups container mx-auto my-auto py-2 px-4 shadow-lg rounded-xl">
            <!-- T√≠tulo -->
            <h1 class="text-3xl font-bold text-center my-6">Proveedores Contratados</h1>
            <!-- Paginaci√≥n -->
            <div id="content-pagination" class="relative bg-transparent">
                <form method="GET" action="">
                    <div class="relative w-[200px] min-w-[200px] z-0 mb-0 flex-1 border border-gray-300 rounded-md bg-white">
                        <input type="number" name="page" id="page" min="1" max="{{ info_page.paginator.num_pages }}" data-total-pages="{{ info_page.paginator.num_pages }}" class="block py-2.5 px-0 w-full text-sm text-gray-900 bg-gray-100 border-0 border-b-2 border-gray-300 appearance-none focus:outline-none focus:ring-0 focus:border-blue-600 peer" placeholder=" " oninput="updatePageLink()" />
                        <label for="page" class="absolute font-medium text-sm text-gray-500 duration-300 transform -translate-y-6 scale-75 top-3 left-0 origin-[0_0] bg-gray-100 px-1 peer-placeholder-shown:translate-y-0 peer-placeholder-shown:scale-100 peer-focus:-translate-y-5 peer-focus:scale-75">
                            <p>Pagina <span id="page-number" class="font-bold">{{ info_page.number }}</span> de <span class="font-semibold">{{ info_page.paginator.num_pages }}</span></p>
                        </label>
                    </div>
                    <div class="relative flex justify-end space-x-4 bg-transparent">
                        <button id="btn-page" type="submit" onclick="loadPage(event)" class="buttons-pagination text-blue-500 font-semibold">Ir</a>
                        <button id="btn-first" type="button" onclick="buttonFirst(event)" class="buttons-pagination text-blue-500 font-semibold">Primera</button>
                        <button id="btn-previous" type="button" onclick="buttonPrevious(event)" class="buttons-pagination text-blue-500 font-semibold"><span id="previous" class="text-blue-500 font-semibold">1</span> Anterior</button>
                        <button id="btn-next" type="button" onclick="buttonNext(event)" class="buttons-pagination text-blue-500 font-semibold">Siguiente <span id="next" class="text-blue-500 font-semibold">2</span></button>
                        <button id="btn-last" type="button" onclick="buttonLast(event)" class="buttons-pagination text-blue-500 font-semibold">√öltima</button>
                    </div>
                </form>
            </div>
        </div>
    </section>
    <!-- Tabla -->
    <section class="content-table-cups w-full py-4 shadow-xl flex justify-center items-center bg-[#f3f4f581]">
        <div id="medicamentos-table-container" class="overflow-x-auto w-[90%] h-[70vh] bg-[#f3f4f562] rounded-xl shadow-xl">
            {% include 'partials/proveedores_table.html' %}
        </div>
    </section>    
    <!-- Seccion Mapa -->
    <section id="section-maps" class="content-div-actas w-full bg-[#f3f4f581] h-max-auto">
        <div class="vista-movil w-full bg-[#f3f4f562] shadow-xl">
            <div class="mapa-container bg-[#f3f4f581] h-full rounded-xl shadow-xl">
                <div class="content-mapa h-full shadow-xl bg-[#f3f4f581]">
                    <h1 class="title-map text-3xl text-white font-bold text-center my-6">Mapa Red Asistencial</h1>
                    <!-- Contenedor Mapa -->
                    <div id="map" class="mapa relative z-0">
                        <!-- Mapa -->
                    </div>
                </div>
                <div class="content-proveedores-mapa bg-[#f3f4f562] h-full rounded-xl shadow-xl overflow-y-auto text-[10px]">
                    <p class="title-proveedores-mapa font-bold text-center">Prestadores Encontrados {{ proveedores_mapa|length }}</p>
                    {% for proveedor in proveedores_mapa %}
                    <div class="proveedor-mapa p-3 border border-gray-300 mb-2">
                        <p><strong>NIT Proveedor:</strong> {{ proveedor.nit }}</p>
                        <p><strong>Proveedor:</strong> {{ proveedor.nombre }}</p>
                        <p><strong>Tipo de Proveedor:</strong> {{ proveedor.tipo_proveedor }}</p>
                        <p><strong>N√∫mero & A√±o Contrato:</strong> {{ proveedor.numero_contrato }} - {{ proveedor.year_contrato }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
    {% include 'partials/alert.html' %}
</section>
<!-- {% load json_filters %} -->
<pre class="">{{ mapa_data|json_script }}</pre>
<script type="application/json">
    {{ mapa_data|json_script }}
</script>

<script src="{% static 'medicamentos/js/page-button.js' %}"></script>

<script src="{% static 'medicamentos/js/load-map.js' %}"></script>
{% endblock %}
